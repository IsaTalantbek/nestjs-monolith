generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum AccountRole {
	/// Владелец сайта - царь и бог
	owner
	/// Пользователь сайта - обычный смертный
	user
	/// Разработчик сайта (не владелец) - бравые ребята присоединившиеся после релиза
	developer
	/// Модератор сайта (не разработчик) - те кто могут выдать бан
	moderator
	/// Тех-поддержка сайта (не модератор) - те кто ответят на любой вопрос и передадут его выше
	support

	@@map("accounts_roles")
}

enum AccountState {
	/// Только создан и не подтверждён по почте и тп
	created
	/// Обычный аккаунт
	activated
	/// Удалённый аккаунт (пользователем или системой)
	deleted
	/// Заблокированный аккаунт
	banned

	@@map("accounts_states")
}

model Account {
	id				String			@id @default(uuid()) 
	accountRole 	AccountRole		@map("account_role") @default(user)
	accountState	AccountState	@map("account_state") @default(created)
	profileId		String? 		@unique
	profile  		Profile?		@relation("UserInfo", fields: [profileId], references: [id])
	blacklist		BlackList[]
	post			Post[]

	login			String			@unique
	password		String
	tfaCode			String?			@unique @map("tfa_code")
	email			String?			@unique
	phone			String?			@unique
	
	createAt		DateTime		@map("create_at") @default(now())
	createBy		String			@map("create_by")
	updateAt		DateTime?		@map("update_at") @updatedAt
	updateBy		String?			@map("update_by") 
	deleteAt		DateTime?		@map("delete_at")
	deleteBy		String?			@map("delete_by") 
	deleted			Boolean?

	@@map("accounts")
	@@unique([login, email])
}

enum ProfileType {
	/// Личная страница - 1 профиль к 1 аккаунту
	personal			
	/// Сообщество для читателей
	readers_community	
	/// Сообщество для авторов
	authors_community	
	/// Авторское объединение (для со-авторства)
	authors_union		

	@@map("profiles_types")
}

enum ProfileState {
	/// Только создан и не подтверждён по почте и тп
	created
	/// Обычный профиль
	activated
	/// Удалённый профиль (одним из владельцев или системой)
	deleted
	/// Заблокированный профиль
	banned

	@@map("profiles_states")
}

model Profile {
	id					String			@id @default(uuid()) 
	profileType			ProfileType		@map("profile_type") @default(readers_community)
	profileState		ProfileState	@map("profile_state") @default(created)
	cityId				String?			@map("city_id") 
	avatarImageId		String?			@map("avatar_image_id") 
	coverImageId		String?			@map("cover_image_id") 
	passwordLength		Int             @map("password-length")
	like				Like[]			
	post				Post[]			
	
	official			Boolean			@default(false) //Имеется ввиду, подтвержденный человек

	username            String?
	user    			Account?  		@relation("UserInfo")
	userId				String?			

	slug				String?			@map("account_slug")
	displayName			String?			@map("display_name")
	verificationInfo	Json?			@map("verification_info")
	shortInfo			Json?			@map("short_info")
	extraInfo			Json?			@map("extra_info")
	otherLinks			Json?			@map("other_links")

	createAt			DateTime		@map("create_at") @default(now())
	createBy			String			@map("create_by") 
	updateAt			DateTime?		@map("update_at") @updatedAt
	updateBy			String?			@map("update_by") 
	deleteAt			DateTime?		@map("delete_at")
	deleteBy			String?			@map("delete_by") 
	deleted				Boolean?

	@@map("profiles")
}



enum AccountProfileRelationRank {
	/// Владелец личного профиля, сообщества, организатор со-авторства и тд - полный набор прав
	owner
	/// Администратор профиля, подчинённый владельца - набор прав согласно выданной роли
	administrator
	/// Модератор профиля, подчинённый владельца и администраторов - набор прав согласно выданной роли
	moderator
	/// Подписчик профиля, рядовой читатель - набор прав согласно выданной роли
	subscriber

	@@map("accounts_profiles_relations_types")
}

enum  PostType {
	article //Статья

	poetry //Стих
	@@map("post_type")
}

model Post {
	id                 	String			@id @default(uuid())
	profile				Profile			@relation(fields: [profileId], references: [id])
	user				Account			@relation(fields: [userId], references: [id])
	userId				String
	profileId			String
	actual				Boolean			@default(true)
	like				Like[]

	type				PostType
	text				String			 			
	links				Json?
	image				String?
	likes				Int				@default(0)
	dislikes			Int				@default(0)
	tags				Tags[]			@relation("post-tags")

	createAt			DateTime		@map("create_at") @default(now())
	createBy			String			@map("create_by") 
	updateAt			DateTime?		@map("update_at") @updatedAt
	updateBy			String?			@map("update_by") 
	deleteAt			DateTime?		@map("delete_at")
	deleteBy			String?			@map("delete_by") 
	deleted				Boolean?
	@@map("post")				
}

model Tags {
	id      Int      @id @default(autoincrement())
  name    String   @unique
  posts   Post[]   @relation("post-tags")
}


model Like {
	id 					String			@id @default(uuid())
	userId				String
	postId				String
	type				String			@default("like")
	user				Profile			@relation(fields: [userId], references: [id])
  	post    			Post     		@relation(fields: [postId], references: [id]) 
	
	createAt			DateTime		@map("create_at") @default(now())
	createBy			String			@map("create_by") 
	updateAt			DateTime?		@map("update_at") @updatedAt
	updateBy			String?			@map("update_by") 
	deleteAt			DateTime?		@map("delete_at")
	deleteBy			String?			@map("delete_by") 
	deleted				Boolean?	
  	@@unique([userId, postId, type]) // Гарантирует уникальность комбинации
}


model BlackList {
	id					String			@id @default(uuid()) 
	account             Account			@relation(fields: [userId], references: [id])
	userId				String
	vsUserId            String

	createAt			DateTime		@map("create_at") @default(now())    
	createBy			String			@map("create_by")
	updateAt			DateTime?		@map("update_at") @updatedAt
	updateBy			String?			@map("update_by") 
	active				Boolean 		@default(true)
	@@unique([userId, vsUserId])
	@@map("black_list")
}

